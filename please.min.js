/*! please.js - v0.1.0 - 2013-06-20 
* Copyright (c) 2013 Wingify; Licensed MIT */
!function($){function Request(){this.init.apply(this,[].slice.call(arguments))}function Response(a){this.init(a)}function UnserializableResponseData(a){this.id=a,this.type="unserializable"}var defaults={targetWindow:window,targetOrigin:"*"},please=function(a,b){return $.extend(please.bind(),{targetWindow:a,targetOrigin:b,call:please.call,set:please.set,get:please.get,eval:please.eval,$:please.$})},requests={},responses={};window.please=please,please.requests=requests,please.responses=responses,please.defaults=function(a){$.extend(!0,defaults,a)},please.init=function(a){a.addEventListener("message",please_messageHandler)};var please_request=function(a){return function(){var b=new Request(a);return b.targetWindow=this.targetWindow||defaults.targetWindow,b.targetOrigin=this.targetOrigin||defaults.targetOrigin,b.data=[].slice.call(arguments),b.send(),b}},please_messageHandler=function(a){try{var b=JSON.parse(a.data)}catch(c){return console.log("error parsing json data"),void 0}if("request"===b.type){var d=new Response(b);responses[d.id]=d.data,d.targetWindow=a.source,d.targetOrigin=a.origin,d.send()}else"response"===b.type&&(console.log("response received:",b),b.data&&"unserializable"===b.data.type&&(b.data=UnserializableResponseData.create(b.data)),requests[b.id].resolve(b.data),delete requests[b.id])};please.call=please_request("call"),please.set=please_request("set"),please.get=please_request("get"),please.eval=please_request("eval"),please.$=please_request("$"),please.$=function(){for(var a=please_request("$").apply(this,[].slice.call(arguments)),b=Object.keys($.fn),c=function(a){for(var b in a)"function"==typeof a[b]&&(a[b]=a[b].toString())},d=function(a){return a.map(function(a){return"function"==typeof a?a.toString():("object"==typeof a&&($.extend(!0,{},a),c(a)),a)})},e=function(a){return function(){var b=[].slice.call(arguments);b=d(b);var c=new Request("$_fn");return c.targetWindow=this.targetWindow||defaults.targetWindow,c.targetOrigin=this.targetOrigin||defaults.targetOrigin,c.data=[this,a].concat(b),c.send(),c}},f=0,g=b.length;g>f;f++){var h=b[f];"constructor"!==h&&"init"!==h&&"promise"!==h&&"function"==typeof $.fn[h]&&(a[h]=e(h))}var i=["draggable","sortable"];for(f=0,g=i.length;g>f;f++){var h=i[f];a[h]=e(h)}return a};var please_call=function(a){var b,c=a.split("."),d=b=window,e=[].slice.call(arguments,1);return c.forEach(function(a,e){e===c.length-1&&(b=d),d=d[a]}),d.apply(b,e)},please_set=function(a,b){var c=a.split("."),d=window;c.forEach(function(a,e){e===c.length-1?d[a]=b:d=d[a]})},please_get=function(a){var b=a.split("."),c=window;return b.forEach(function(a){c=c[a]}),c},please_eval=function(a){$.globalEval(a)},please_$=function(){return $.apply($,[].slice.call(arguments))},please_$_fn=function(parentReq,funcName){var $jq=responses[parentReq.id];if(!($jq instanceof $))return null;for(var args=[].slice.call(arguments,2),i=0;i<args.length;i++)args[i]=function(arg){if("string"==typeof arg)try{var fn;return eval("fn = "+arg),"function"==typeof fn?fn:arg}catch(e){return arg}return"object"==typeof arg&&mapObjectStringsToFunctions(arg),arg}(args[i]);var retval;return retval="length"===funcName?$jq.length:$jq[funcName].apply($jq,args)};Request.prototype={init:function(a){$.extend(this,$.Deferred());for(var b=+new Date;b===+new Date;);b=+new Date,this.id=b,this.name=a,this.data=[].slice.call(arguments),requests[b]=this},send:function(){this.targetWindow=this.targetWindow||defaults.targetWindow,this.targetOrigin=this.targetOrigin||defaults.targetOrigin;try{var a=this.data,b=a instanceof $?a.toArray():a;if(b&&b.length&&b[0]instanceof Node)throw"";this.targetWindow.postMessage(JSON.stringify(this),this.targetOrigin),console.log(window.location.href,"sent message:",JSON.stringify(this))}catch(c){console.log(window.location.href,"sent message: Unserializable#",this.id),this.targetWindow.postMessage(new UnserializableResponseData(this.id),this.targetOrigin)}},perform:function(){var please_fn;return eval("please_fn = please_"+this.name),please_fn.apply(this,this.data)},toJSON:function(){return{id:this.id,name:this.name,type:"request",data:this.data}}},Request.create=function(a){return $.extend(new Request,a)},Response.prototype={init:function(a){this.id=a.id,this.name=a.name,this.data=Request.create(a).perform()},send:function(){try{var a=this.data,b=a instanceof $?a.toArray():a;if(b&&b.length&&b[0]instanceof Node)throw"";JSON.stringify(this),this.targetWindow.postMessage(JSON.stringify(this),this.targetOrigin)}catch(c){this.data=new UnserializableResponseData(this.id),this.targetWindow.postMessage(JSON.stringify(this),this.targetOrigin)}console.log(window.location.href,"sent message:",JSON.stringify(this))},toJSON:function(){return{id:this.id,name:this.name,type:"response",data:this.data}}},UnserializableResponseData.create=function(a){var b=$.extend(new UnserializableResponseData,a);return b},please.Request=Request,please.Response=Response,please.UnserializableResponseData=UnserializableResponseData}(jQuery);